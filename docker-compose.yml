###############################################################################
# docker-compose.yml - Singer REST API Tap + Config Builder UI
#
# Services:
#   app - Combined container (UI + Tap) — recommended for local Docker Desktop
#   ui  - Standalone UI (no tap runner)
#   tap - Standalone tap CLI (runs on demand)
#
# Quick start:
#   docker compose build app
#   docker compose up -d app
#   # Open http://localhost:9090
#
# Standalone usage (separate containers):
#   docker compose build ui tap
#   docker compose up -d ui
#   docker compose run --rm --profile cli tap --config /app/config/config.json --discover
#
# Stop:
#   docker compose down
###############################################################################

services:
  # --------------------------------------------------------------------------
  # App: Combined container — UI + Python tap in one image (recommended)
  # --------------------------------------------------------------------------
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: singer-tap-builder
    ports:
      - "9090:9090"
    volumes:
      - app-data:/app/server/data
      - app-config:/app/config
      - app-output:/app/output
      - app-state:/app/state
      - app-logs:/app/logs
    environment:
      - NODE_ENV=production
      - PORT=9090
      - PYTHONUNBUFFERED=1
      - ALLOWED_ORIGINS=http://localhost:9090
    # Security hardening
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:size=100M
    mem_limit: 2g
    cpus: 2
    pids_limit: 100
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/api/health"]
      interval: 30s
      timeout: 5s
      start_period: 15s
      retries: 3

  # --------------------------------------------------------------------------
  # UI: Standalone web UI (no tap runner — config builder only)
  # --------------------------------------------------------------------------
  ui:
    build:
      context: ./ui
      dockerfile: Dockerfile
    container_name: tap-config-builder
    ports:
      - "3001:3001"
    volumes:
      - ui-data:/app/server/data
    environment:
      - NODE_ENV=production
      - PORT=3001
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/api/health"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3
    profiles:
      - standalone

  # --------------------------------------------------------------------------
  # Tap: Standalone Singer tap CLI (runs on demand)
  # --------------------------------------------------------------------------
  tap:
    build:
      context: ./taps/tap-rest-api-generic
      dockerfile: Dockerfile
    container_name: tap-rest-api
    volumes:
      - tap-config:/app/config
      - tap-output:/app/output
      - tap-state:/app/state
      - tap-logs:/app/logs
    environment:
      - PYTHONUNBUFFERED=1
    profiles:
      - cli

  # --------------------------------------------------------------------------
  # Confluent Kafka — for testing target-confluent-kafka
  # Start: docker compose --profile kafka up -d
  # --------------------------------------------------------------------------
  kafka:
    image: confluentinc/cp-kafka:7.7.0
    container_name: singer-kafka
    hostname: kafka
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:29092,CONTROLLER://0.0.0.0:9093,PLAINTEXT_HOST://0.0.0.0:9092
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      CLUSTER_ID: MkU3OEVBNTcwNTJENDM2Qk
    mem_limit: 1g
    restart: unless-stopped
    profiles:
      - kafka

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: singer-kafka-ui
    ports:
      - "8080:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: singer-local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
    depends_on:
      - kafka
    restart: unless-stopped
    profiles:
      - kafka

# ---------------------------------------------------------------------------
# Named volumes for data persistence
# ---------------------------------------------------------------------------
volumes:
  # Combined app volumes
  app-data:
    driver: local
  app-config:
    driver: local
  app-output:
    driver: local
  app-state:
    driver: local
  app-logs:
    driver: local

  # Standalone UI volume
  ui-data:
    driver: local

  # Standalone tap volumes
  tap-config:
    driver: local
  tap-output:
    driver: local
  tap-state:
    driver: local
  tap-logs:
    driver: local
